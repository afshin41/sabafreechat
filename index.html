<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Tahoma, sans-serif; background: #ECE5DD; margin:0; display:flex; flex-direction:column; height:100vh;}
header { background:#128C7E; color:#fff; padding:10px 20px; display:flex; justify-content: space-between; align-items:center; border-bottom-left-radius:20px; border-bottom-right-radius:20px;}
#friendKey{padding:8px 12px; border-radius:20px; border:none; font-size:14px; width:200px;}
#startBtn{padding:8px 20px; border-radius:20px; border:none; background:#075E54; color:#fff; font-weight:bold; cursor:pointer;}
#connectionStatus{margin-left:10px;font-size:14px;font-weight:bold;}
.chat-wrapper{flex:1; display:flex; flex-direction:column; padding:10px; overflow-y:auto; gap:5px; scroll-behavior:smooth;}
.msg{padding:10px 15px; max-width:70%; word-wrap:break-word; position:relative; border-radius:20px; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s ease;}
.msg .time{font-size:10px;color:#555;margin-top:5px;text-align:right;}
.left{background:#D2B48C; color:#000; align-self:flex-start; border-radius:20px;}
.right{background:#128C7E; color:#fff; align-self:flex-end; text-align:right; border-radius:20px;}
.date-divider{text-align:center; font-size:12px; color:#555; margin:10px 0;}
.typing-status{font-size:12px;color:#555;margin-left:10px;}
footer{display:flex; padding:10px; background:#f0f0f0; gap:10px; align-items:center; flex-direction: row-reverse;}
footer input{flex:1; padding:12px; border-radius:25px; border:1px solid #ccc; font-size:16px;}
footer button{padding:12px 20px; border-radius:25px; border:none; background:#128C7E; color:#fff; font-weight:bold; cursor:pointer;}
</style>
</head>
<body>
<header>
  <button type="button" id="startBtn">Chat</button>
  <input type="text" id="friendKey" placeholder="Enter friend key">
  <div id="connectionStatus">Disconnected ❌</div>
</header>

<div class="chat-wrapper" id="chat"></div>
<div id="typingStatus" class="typing-status"></div>

<footer>
  <input type="text" id="messageInput" placeholder="Type your message" oninput="sendTypingStatus()">
  <button onclick="sendMessage()">Send</button>
</footer>

<script>
let socket;
let pendingMessages = [];
let lastDate = "";
let friendKeyGlobal = "";

function formatDate(date){ return date.getFullYear()+"/"+(date.getMonth()+1)+"/"+date.getDate(); }

function updateConnectionStatus(text,color){
  const el = document.getElementById("connectionStatus");
  el.innerText = text;
  el.style.color = color;
}

document.getElementById("startBtn").addEventListener("click", (e)=>{
  e.preventDefault();
  startChat();
});

function startChat(){
  const friendKey = document.getElementById('friendKey').value.trim();
  if(!friendKey){ alert("Please enter friend key"); return; }
  friendKeyGlobal = friendKey;

  updateConnectionStatus("Connecting...", "orange");

  socket = new WebSocket("wss://sabafreechat.onrender.com");

  socket.onopen = () => {
    updateConnectionStatus("Connected ✅", "green");
    socket.send(JSON.stringify({type:"join", key:friendKey}));
    pendingMessages.forEach(msg => socket.send(JSON.stringify(msg)));
    pendingMessages = [];
  };

  socket.onerror = () => updateConnectionStatus("Connection error ⚠️", "orange");
  socket.onclose = () => updateConnectionStatus("Disconnected ❌", "red");

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if(data.type === "msg") addMessage("Friend", data.text, "left");
    else if(data.type === "typing") showTypingStatus(data.status);
    else if(data.type === "system") addMessage("System", data.text, "left");
  };
}

function sendMessage(){
  const msg = document.getElementById('messageInput').value.trim();
  if(!msg) return;
  const messageData = { type:"msg", key:friendKeyGlobal, text: msg };
  addMessage("Me", msg, "right");
  if(socket && socket.readyState === WebSocket.OPEN){
    socket.send(JSON.stringify(messageData));
  } else {
    pendingMessages.push(messageData);
  }
  document.getElementById('messageInput').value = '';
  sendTypingStatus(false);
}

function sendTypingStatus(status=true){
  if(socket && socket.readyState === WebSocket.OPEN){
    socket.send(JSON.stringify({type:"typing", key:friendKeyGlobal, status}));
  }
}
function showTypingStatus(status){ document.getElementById('typingStatus').innerText=status?"Friend is typing...":""; }

function addMessage(sender,text,side){
  const chat=document.getElementById('chat');
  const now=new Date(); const today=formatDate(now);
  if(today!==lastDate){ const divDate=document.createElement('div'); divDate.className='date-divider'; divDate.innerText=today; chat.appendChild(divDate); lastDate=today; }
  const div=document.createElement('div'); div.className="msg "+side; div.innerHTML=text.replace(/\n/g,"<br>");
  const timeSpan=document.createElement('div'); timeSpan.className="time"; timeSpan.innerText=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0'); div.appendChild(timeSpan);
  chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
}
</script>
</body>
</html>
